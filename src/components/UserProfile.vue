<template>
  <div v-if="isLogin">
    <div v-if="session.role === 'student'">
      <h2 class="section-title" style="position: absolute; top: 150px">
        å€‹äººè³‡è¨Š
      </h2>

      <hr class="custom-hr1" />
      <section class="contact-us">
        <div class="container">
          <div class="row">
            <div class="info-wrapper">
              <div class="info-line">
                <span class="info-label">å­¸è™Ÿ</span>
                <span class="info-value" id="student-id">{{
                  session.user_id
                }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">å§“å</span>
                <span class="info-value" id="student-name">{{
                  session.username
                }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">å…¥å­¸å¹´ä»½</span>
                <span class="info-value">{{ enrollmentYear }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">å°±è®€å­¸ç³»</span>
                <span class="info-value" id="student-name">{{
                  session.department_name
                }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">å¹´ç´š</span>
                <span class="info-value">{{ gradeNumber }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">ç­ç´š</span>
                <span class="info-value">{{ className }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">åº§è™Ÿ</span>
                <span class="info-value">{{ seatNumber }}</span>
              </div>
              <br />
            </div>
          </div>
        </div>
      </section>

      <h2 class="section-title">ç”³è«‹è½‰ç³»</h2>
      <hr class="custom-hr2" />
      <div class="container mt-4">
        <div class="row">
          <div class="col-lg-12">
            <div class="alert alert-info" role="alert">
              <strong>æš«ç„¡ç”³è«‹å­¸ç³»</strong>
            </div>

            <!-- è¡¨æ ¼å€åŸŸï¼ŒåŠ ä¸Š radius -->
            <div class="table-responsive mt-4" style="border-radius: 12px">
              <table class="table apply-table">
                <thead>
                  <tr>
                    <th>å­¸é™¢</th>
                    <th>å­¸ç³»</th>
                    <th>ç”³è«‹æˆªæ­¢æ—¥</th>
                    <th>å¯©æŸ¥æ–¹å¼</th>
                    <th>å‚™è¨»</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>è—è¡“å­¸é™¢</td>
                    <td>éŸ³æ¨‚å­¸ç³»</td>
                    <td>5/31</td>
                    <td>ç­†è©¦ï¼šæœ‰ã€å£è©¦ï¼šæœ‰ã€æ›¸å¯©ï¼šç„¡</td>
                    <td>
                      <span class="text-truncate"
                        >1.é™ä¸»ä¿®é‹¼ç´ã€è²æ¨‚ã€å¼¦æ¨‚ã€ç®¡æ¨‚â€¦</span
                      >
                    </td>
                  </tr>
                  <tr>
                    <td>æ–‡å­¸é™¢</td>
                    <td>ä¸­åœ‹æ–‡å­¸ç³»</td>
                    <td>5/31</td>
                    <td>ç­†è©¦ï¼šç„¡ã€å£è©¦ï¼šæœ‰ã€æ›¸å¯©ï¼šæœ‰</td>
                    <td>
                      <span class="text-truncate"
                        >1.å­¸æ¥­æˆç¸¾ç¸½å¹³å‡60åˆ†ä»¥ä¸Šã€‚2.â€¦</span
                      >
                    </td>
                  </tr>
                  <tr>
                    <td>æ–‡å­¸é™¢</td>
                    <td>æ­·å²å­¸ç³»</td>
                    <td>5/31</td>
                    <td>ç­†è©¦ï¼šç„¡ã€å£è©¦ï¼šæœ‰ã€æ›¸å¯©ï¼šç„¡</td>
                    <td>
                      <span class="text-truncate"
                        >1.é ˆé™„è‡ªå‚³(å«ç”³è«‹å‹•æ©Ÿ)ã€‚2.å£è©¦â€¦</span
                      >
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <h2 class="section-title mt-5">æˆ‘çš„æœ€æ„›</h2>
      <hr class="custom-hr2" />
      <div class="container mt-4">
        <div class="row">
          <div class="col-lg-12" v-if="favoriteDepartments.length > 0">
            <div
              class="table-responsive mt-4"
              style="border-radius: 12px; overflow: hidden"
            >
              <table class="table my-fav-table table-hover align-middle">
                <thead>
                  <tr>
                    <th>å­¸é™¢</th>
                    <th>å­¸ç³»</th>
                    <th>äºŒå¹´ç´šåé¡</th>
                    <th>ä¸‰å¹´ç´šåé¡</th>
                    <th>å››å¹´ç´šåé¡</th>
                    <th>ç­†è©¦</th>
                    <th>å£è©¦</th>
                    <th>è³‡æ–™å¯©æŸ¥</th>
                    <th>ç°¡è¿°</th>
                    <th>é»æ“Šå–æ¶ˆæœ€æ„›</th>
                  </tr>
                </thead>

                <tbody>
                  <tr
                    @click="goToDetail(favorite.department_id)"
                    v-for="(favorite, index) in favoriteDepartments"
                    :key="index"
                  >
                    <td>{{ favorite.faculty }}</td>
                    <td>{{ favorite.name }}</td>
                    <td>{{ favorite.second_year_quota }}äºº</td>
                    <td>{{ favorite.third_year_quota }}äºº</td>
                    <td>{{ favorite.fourth_year_quota }}äºº</td>
                    <td>{{ favorite.written_exam_weight }}%</td>
                    <td>{{ favorite.interview_weight }}%</td>
                    <td>{{ favorite.review_weight }}%</td>
                    <td style="text-align: left">
                      <span
                        class="d-inline-block text-truncate"
                        style="max-width: 240px"
                      >
                        {{ favorite.brief_description }}
                      </span>
                    </td>
                    <td>
                      <button
                        class="favorite-btn"
                        @click.stop="removeFavorite(favorite.department_id)"
                      >
                        <span>â¤ï¸</span>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="col-lg-12" v-else>
            <div class="alert alert-warning" role="alert">
              <strong>ç›®å‰å°šæœªæ”¶è—ä»»ä½•å­¸ç³»</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div v-else>
      <h2 class="section-title" style="position: absolute; top: 150px">
        å­¸ç³»ç®¡ç†å“¡è³‡è¨Š
      </h2>
      <hr class="custom-hr1" />
      <section class="contact-us">
        <div class="container">
          <div class="row">
            <div class="info-wrapper">
              <div class="info-line">
                <span class="info-label">æ•™è·å“¡è™Ÿ</span>
                <span class="info-value" id="student-id">{{
                  session.user_id
                }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">è·ç¨±</span>
                <span class="info-value" id="student-name">{{
                  session.username
                }}</span>
              </div>
              <br />
            </div>
          </div>
        </div>
      </section>

      <h2 class="section-title">
        æœ¬ç³»è½‰ç³»è³‡è¨Š
        <router-link to="/ChangeDept">
          <button type="button" class="btn edit-btn">æ›´æ”¹æœ¬ç³»è½‰ç³»è³‡è¨Š</button>
        </router-link>
        <router-link to="/NewAnnoun">
          <button type="button" class="btn edit-btn ml-1">
            æ–°å¢æœ¬ç³»è½‰ç³»å…¬å‘Š
          </button>
        </router-link>
      </h2>
      <hr class="custom-hr2" />
      <div v-if="departmentData && departmentData.length > 0">
        <div class="row">
          <div class="info-wrapper" style="margin-top: 20px">
            <div class="info-line">
              <span class="info-label">å­¸ç³»</span>
              <span class="info-value">{{ departmentData[0]?.name }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">æ‰€å±¬å­¸é™¢</span>
              <span class="info-value">{{ departmentData[0]?.faculty }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">äºŒå¹´ç´šåé¡</span>
              <span class="info-value">{{
                departmentData[0]?.second_year_quota
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">ä¸‰å¹´ç´šåé¡</span>
              <span class="info-value">{{
                departmentData[0]?.third_year_quota
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">å››å¹´ç´šåé¡</span>
              <span class="info-value">{{
                departmentData[0]?.fourth_year_quota
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">ç°¡è¿°</span>
              <span class="info-value">{{
                departmentData[0]?.brief_description
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">è€ƒè©¦å æ¯”</span>
              <span class="info-value">{{
                departmentData[0]?.written_exam_weight
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">é¢è©¦å æ¯”</span>
              <span class="info-value">{{
                departmentData[0]?.interview_weight
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">æ›¸å¯©å æ¯”</span>
              <span class="info-value">{{
                departmentData[0]?.review_weight
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">å‚™è¨»</span>
              <span class="info-value">{{
                departmentData[0]?.additional_notes
              }}</span>
            </div>
          </div>
        </div>
      </div>

      <h2 class="section-title">è½‰ç³»ç”³è«‹</h2>
      <hr class="custom-hr2" />
      <div class="container mt-4">
        <div class="row">
          <div class="col-lg-12">
            <div class="alert alert-info" role="alert">
              <strong>æš«ç„¡æ”¶åˆ°è½‰ç³»ç”³è«‹</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <ul class="social-icons">
              <li><a href="#">å¤©ä¸»æ•™è¼”ä»å¤§å­¸</a></li>
              <li><a href="#">242062 æ–°åŒ—å¸‚æ–°èŠå€ä¸­æ­£è·¯510è™Ÿ</a></li>
              <li><a href="#">(02) 29052000</a></li>
              <li><a href="#">pubwww@mail.fju.edu.tw</a></li>
            </ul>
          </div>
          <div class="col-lg-12">
            <div class="copyright-text">
              <p>
                | å¤©ä¸»æ•™è¼”ä»å¤§å­¸ Â© 2014-2022
                ç‰ˆæ¬Šæ‰€æœ‰ï¼Œå»ºè­°ä½¿ç”¨IE8.0ä»¥ä¸Šç€è¦½å™¨ç€è¦½
              </p>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>
  <div v-else>
    <router-link to="/LogIn" class="main-button">è«‹å…ˆç™»å…¥</router-link>
  </div>
</template>

<script setup>
import { inject, ref, watch, onMounted } from "vue";

const session = inject("session");

const departmentData = ref(null); // ğŸ”¥ é€™å€‹ç”¨ä¾†å­˜å­¸ç³»è³‡æ–™

const isLogin = ref(false); // ğŸ”¥ é€™å€‹ç”¨ä¾†æ§åˆ¶ç•«é¢
const enrollmentYear = ref("æœªçŸ¥");
const className = ref("æœªçŸ¥");
const seatNumber = ref("æœªçŸ¥");
const gradeNumber = ref("æœªçŸ¥"); // å¹´ç´š

const updateUserData = () => {
  if (session?.value) {
    console.log("âœ… å–å¾— session:", session.value);
    isLogin.value = true; // æœ‰è³‡æ–™ï¼Œæ¨™è¨˜ç™»å…¥
    const userIdString = String(session.value.user_id);
    enrollmentYear.value = `1${userIdString.slice(1, 3)}`;
    className.value =
      userIdString.charAt(5) === "1"
        ? "ç”²ç­"
        : userIdString.charAt(5) === "2"
        ? "ä¹™ç­"
        : "æœªçŸ¥";
    seatNumber.value = userIdString.slice(7, 9);
    gradeNumber.value = 14 - userIdString.slice(1, 3); // å¹´ç´š
  } else {
    console.log("âŒ session é‚„æ˜¯ç©ºçš„");
    isLogin.value = false; // æ²’è³‡æ–™ï¼Œæ¨™è¨˜æœªç™»å…¥
  }
};

// å–å¾—å­¸ç³»è³‡æ–™çš„å‡½å¼
const getDepartmentData = async () => {
  console.log("å–å¾—å­¸ç³»è³‡æ–™çš„å‡½å¼è¢«å‘¼å«äº†");
  if (!session.value) {
    console.error("Session æœªå®šç¾©ï¼Œç„¡æ³•å–å¾—å­¸ç³»è³‡æ–™");
    return;
  }

  console.log("session.value?.department_id:", session.value?.department_id);
  if (session.value?.department_id) {
    try {
      const response = await fetch(
        `/api/SA/department_detail.php?id=${session.value.department_id}`,
        {
          method: "GET",
        }
      );
      if (response.ok) {
        const data = await response.json();
        departmentData.value = data;
        console.log("å­¸ç³»è³‡æ–™:", departmentData.value);
      } else {
        console.error("ç„¡æ³•å–å¾—å­¸ç³»è³‡æ–™", response.status);
      }
    } catch (error) {
      console.error("ç™¼ç”ŸéŒ¯èª¤:", error);
    }
  } else {
    console.error("æ²’æœ‰å­¸ç³» IDï¼Œç„¡æ³•å–å¾—å­¸ç³»è³‡æ–™");
  }
};

//ä¸‹é¢é€™å…©è¡Œè¦åœ¨setupå¯«æ‰èƒ½ä½¿ç”¨router
//searchbarè£¡é¢ä¸æ˜¯ä½¿ç”¨setupæ‰€ä»¥æ‰æ²’ä½¿ç”¨
import { useRouter } from "vue-router";
const router = useRouter();
const goToDetail = async (departmentId) => {
  //ésetupå¯«æ³• this.$router.push(`/DeptDetail/${departmentId}`);
  router.push(`/DeptDetail/${departmentId}`);
};

onMounted(() => {
  console.log("Session å€¼:", session.value);
  updateUserData();
  getDepartmentData();
});

watch(
  () => session.value,
  () => {
    updateUserData();
    getDepartmentData();
  }
);

const favoriteDepartments = ref([]);

// æ”¶è—çš„å‰å¾Œç«¯æ¥å£
const loadFavorites = async () => {
  try {
    const response = await fetch("/api/SA/get_favorite.php");
    if (!response.ok) {
      console.error("å–å¾—æ”¶è—å¤±æ•—:", response.status);
      return;
    }
    const data = await response.json();
    favoriteDepartments.value = data;
    console.log("æ”¶è—å­¸ç³»è³‡æ–™:", favoriteDepartments.value);
  } catch (error) {
    console.error("fetch ç™¼ç”ŸéŒ¯èª¤:", error);
  }
};
//é»æ“Šç´…å¿ƒå¯ä»¥åˆªé™¤æ”¶è—
const removeFavorite = async (departmentId) => {
  try {
    const formData = new FormData();
    formData.append("department_id", departmentId);

    const response = await fetch("/api/SA/remove_favorite.php", {
      method: "POST",
      body: formData,
      credentials: "include",
    });
    const result = await response.json();

    if (result.success) {
      console.log("å–æ¶ˆæ”¶è—æˆåŠŸ", result.message);
    } else {
      console.warn("å–æ¶ˆæ”¶è—å¤±æ•—", result.message); // é¡¯ç¤ºæ˜ç¢ºéŒ¯èª¤
    }

    // å¾å‰ç«¯ç§»é™¤é€™ç­†æ”¶è—
    favoriteDepartments.value = favoriteDepartments.value.filter(
      (dept) => dept.department_id !== departmentId
    );
  } catch (error) {
    console.error("åˆªé™¤æ”¶è—éŒ¯èª¤:", error);
  }
};

onMounted(() => {
  updateUserData();
  getDepartmentData();
  loadFavorites(); // âœ… åŠ é€™è¡Œ
});
</script>


<style scoped>
.info-wrapper {
  margin-top: 270px;
}
.section-title {
  margin-left: 5%;
}

.custom-hr1 {
  position: absolute;
  top: 185px;
  border: 0.5px solid;
  width: 90%;
  margin-left: auto;
  margin-right: auto;
  left: 5%;
}
.custom-hr2 {
  border: 0.5px solid;
  width: 90%;
  margin-left: auto;
  margin-right: auto;
}

li a {
  text-decoration: none;
  color: #007bff;
}
li a:hover {
  text-decoration: underline;
}

.custom-fav-box {
  background-color: rgb(255, 219, 219);
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 12px;
  border: 1px solidrgb(235, 190, 190);
}

::v-deep(.custom-fav-box a) {
  color: #000;
}

.text-truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* æˆ‘çš„æœ€æ„› */
.my-fav-table {
  border: 1px solid #ffeaea;
  border-radius: 12px;
  background-color: rgb(255, 255, 255);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  font-size: 15px;
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

.my-fav-table thead {
  background-color: rgb(255, 241, 241);
  color: rgb(102, 12, 12);
}

.my-fav-table thead th {
  padding: 14px 12px;
  text-align: center;
  font-weight: bold;
  border-bottom: 1px solid #f3d6d6;
}

.my-fav-table thead th:first-child {
  border-top-left-radius: 12px;
}
.my-fav-table thead th:last-child {
  border-top-right-radius: 12px;
}

.my-fav-table th,
.my-fav-table td {
  padding: 10px px8;
  vertical-align: middle;
  text-align: center;
  line-height: 1.5;
  font-size: 15px;
  color: #333;
  border-top: 1px solid #f3d6d6; /* èˆ‡ç”³è«‹è¡¨æ ¼ä¸€è‡´å°æ‡‰çš„é‚Šç·šç²—ç´° */
}

.my-fav-table tbody tr:nth-child(even) td {
  background-color: rgb(255, 241, 241);
}

.my-fav-table tbody tr:hover td {
  background-color: rgb(251, 233, 233);
  transition: background-color 0.2s ease;
}

.my-fav-table tbody tr:first-child td:first-child {
  border-top-left-radius: 12px;
}
.my-fav-table tbody tr:first-child td:last-child {
  border-top-right-radius: 12px;
}
.my-fav-table tbody tr:last-child td:first-child {
  border-bottom-left-radius: 12px;
}
.my-fav-table tbody tr:last-child td:last-child {
  border-bottom-right-radius: 12px;
}

.my-fav-table .text-truncate {
  display: block;
  max-width: 240px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ç”³è«‹ */
.apply-table {
  border: 1px solid #d5e7f8;
  border-radius: 12px;
  background-color: #ffffff;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  font-size: 15px;
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

/* è¡¨é ­ */
.apply-table thead {
  background-color: #eef5fb;
  color: #0c3b66;
}

.apply-table thead th {
  padding: 14px 12px;
  text-align: center;
  font-weight: bold;
  border-bottom: 1px solid #d5e7f8;
}

/* è¡¨é ­å·¦å³åœ“è§’ */
.apply-table thead th:first-child {
  border-top-left-radius: 12px;
}
.apply-table thead th:last-child {
  border-top-right-radius: 12px;
}

/* è¡¨æ ¼å…§å®¹ */
.apply-table td {
  padding: 12px 14px;
  vertical-align: middle;
  line-height: 1.5;
  font-size: 15px;
  color: #333;
  border-top: 1px solid #eef3f8;
}

/* å¶æ•¸åˆ—æ·¡åº• */
.apply-table tbody tr:nth-child(even) td {
  background-color: #f7fbff;
}

/* hover æ•ˆæœï¼šæŸ”å’Œè—åº•ï¼Œä¸ç ´å£åœ“è§’ */
.apply-table tbody tr:hover td {
  background-color: #eaf4ff;
  transition: background-color 0.2s ease;
}

.apply-table tbody tr:first-child td:first-child {
  border-top-left-radius: 12px;
}
.apply-table tbody tr:first-child td:last-child {
  border-top-right-radius: 12px;
}
.apply-table tbody tr:last-child td:first-child {
  border-bottom-left-radius: 12px;
}
.apply-table tbody tr:last-child td:last-child {
  border-bottom-right-radius: 12px;
}

/* å‚™è¨»æ–‡å­—éé•·æ™‚æˆªæ–· */
.apply-table .text-truncate {
  display: block;
  max-width: 240px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.favorite-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 24px;
  color: #ff0000; /* ç´…è‰² */
}
</style>
