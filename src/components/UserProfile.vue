<template>
  <div v-if="isLogin">
    <div v-if="session.role === 'student'">
      <h2 class="section-title" style="position: absolute; top: 150px">
        å€‹äººè³‡è¨Š
      </h2>

      <hr class="custom-hr1" />
      <section class="contact-us">
        <div class="container">
          <div class="row">
            <div class="info-wrapper">
              <div class="info-line">
                <span class="info-label">å­¸è™Ÿ</span>
                <span class="info-value" id="student-id">{{
                  session.user_id
                }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">å§“å</span>
                <span class="info-value" id="student-name">{{
                  session.username
                }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">å…¥å­¸å¹´ä»½</span>
                <span class="info-value">{{ enrollmentYear }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">å°±è®€å­¸ç³»</span>
                <span class="info-value" id="student-name">{{
                  session.department_name
                }}</span>
              </div>

              <div class="info-line">
                <span class="info-label">ç­ç´š</span>
                <span class="info-value">{{ className }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">åº§è™Ÿ</span>
                <span class="info-value">{{ seatNumber }}</span>
              </div>
              <br />
            </div>
          </div>
        </div>
      </section>

      <h2 class="section-title">ç”³è«‹è½‰ç³»</h2>
      <hr class="custom-hr2" />
      <div class="container mt-4">
        <div class="row">
          <div class="col-lg-12">
            <div class="alert alert-info" role="alert">
              <strong>æš«ç„¡ç”³è«‹å­¸ç³»</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div v-else>
      <h2 class="section-title" style="position: absolute; top: 150px">
        å­¸ç³»ç®¡ç†å“¡è³‡è¨Š
      </h2>
      <hr class="custom-hr1" />
      <section class="contact-us">
        <div class="container">
          <div class="row">
            <div class="info-wrapper">
              <div class="info-line">
                <span class="info-label">æ•™è·å“¡è™Ÿ</span>
                <span class="info-value" id="student-id">{{
                  session.user_id
                }}</span>
              </div>
              <div class="info-line">
                <span class="info-label">è·ç¨±</span>
                <span class="info-value" id="student-name">{{
                  session.username
                }}</span>
              </div>
              <br />
            </div>
          </div>
        </div>
      </section>

      <h2 class="section-title">
        æœ¬ç³»è½‰ç³»è³‡è¨Š
        <button type="button" class="btn btn-danger">æ›´æ”¹æœ¬ç³»è½‰ç³»è³‡è¨Š</button>
      </h2>
      <hr class="custom-hr2" />
      <div v-if="departmentData && departmentData.length > 0">
        <div class="row">
          <div class="info-wrapper" style="margin-top: 20px">
            <div class="info-line">
              <span class="info-label">å­¸ç³»</span>
              <span class="info-value">{{ departmentData[0]?.name }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">æ‰€å±¬å­¸é™¢</span>
              <span class="info-value">{{ departmentData[0]?.faculty }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">äºŒå¹´ç´šåé¡</span>
              <span class="info-value">{{
                departmentData[0]?.second_year_quota
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">ä¸‰å¹´ç´šåé¡</span>
              <span class="info-value">{{
                departmentData[0]?.third_year_quota
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">å››å¹´ç´šåé¡</span>
              <span class="info-value">{{
                departmentData[0]?.fourth_year_quota
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">ç°¡è¿°</span>
              <span class="info-value">{{
                departmentData[0]?.brief_description
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">è€ƒè©¦å æ¯”</span>
              <span class="info-value">{{
                departmentData[0]?.written_exam_weight
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">é¢è©¦å æ¯”</span>
              <span class="info-value">{{
                departmentData[0]?.interview_weight
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">æ›¸å¯©å æ¯”</span>
              <span class="info-value">{{
                departmentData[0]?.review_weight
              }}</span>
            </div>
            <div class="info-line">
              <span class="info-label">å‚™è¨»</span>
              <span class="info-value">{{
                departmentData[0]?.additional_notes
              }}</span>
            </div>
          </div>
        </div>
      </div>

      <h2 class="section-title">è½‰ç³»ç”³è«‹</h2>
      <hr class="custom-hr2" />
      <div class="container mt-4">
        <div class="row">
          <div class="col-lg-12">
            <div class="alert alert-info" role="alert">
              <strong>æš«ç„¡æ”¶åˆ°è½‰ç³»ç”³è«‹</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <ul class="social-icons">
              <li><a href="#">å¤©ä¸»æ•™è¼”ä»å¤§å­¸</a></li>
              <li><a href="#">242062 æ–°åŒ—å¸‚æ–°èŠå€ä¸­æ­£è·¯510è™Ÿ</a></li>
              <li><a href="#">(02) 29052000</a></li>
              <li><a href="#">pubwww@mail.fju.edu.tw</a></li>
            </ul>
          </div>
          <div class="col-lg-12">
            <div class="copyright-text">
              <p>
                | å¤©ä¸»æ•™è¼”ä»å¤§å­¸ Â© 2014-2022
                ç‰ˆæ¬Šæ‰€æœ‰ï¼Œå»ºè­°ä½¿ç”¨IE8.0ä»¥ä¸Šç€è¦½å™¨ç€è¦½
              </p>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>
  <div v-else>
    <router-link to="/LogIn" class="main-button">è«‹å…ˆç™»å…¥</router-link>
  </div>
</template>

<script setup>
import { inject, ref, watch, onMounted } from "vue";

const session = inject("session");

const departmentData = ref(null); // ğŸ”¥ é€™å€‹ç”¨ä¾†å­˜å­¸ç³»è³‡æ–™

const isLogin = ref(false); // ğŸ”¥ é€™å€‹ç”¨ä¾†æ§åˆ¶ç•«é¢
const enrollmentYear = ref("æœªçŸ¥");
const className = ref("æœªçŸ¥");
const seatNumber = ref("æœªçŸ¥");

const updateUserData = () => {
  if (session?.value) {
    console.log("âœ… å–å¾— session:", session.value);
    isLogin.value = true; // æœ‰è³‡æ–™ï¼Œæ¨™è¨˜ç™»å…¥
    const userIdString = String(session.value.user_id);
    enrollmentYear.value = `1${userIdString.slice(1, 3)}`;
    className.value =
      userIdString.charAt(5) === "1"
        ? "ç”²ç­"
        : userIdString.charAt(5) === "2"
        ? "ä¹™ç­"
        : "æœªçŸ¥";
    seatNumber.value = userIdString.slice(7, 9);
  } else {
    console.log("âŒ session é‚„æ˜¯ç©ºçš„");
    isLogin.value = false; // æ²’è³‡æ–™ï¼Œæ¨™è¨˜æœªç™»å…¥
  }
};

// å–å¾—å­¸ç³»è³‡æ–™çš„å‡½å¼
const getDepartmentData = async () => {
  console.log("å–å¾—å­¸ç³»è³‡æ–™çš„å‡½å¼è¢«å‘¼å«äº†");
  console.log("session.value?.department_id:", session.value?.department_id);
  if (session.value?.department_id) {
    try {
      const response = await fetch(
        `/api/SA/department_detail.php?id=${session.value?.department_id}`,
        {
          method: "GET",
        }
      ); // å‡è¨­é€™æ˜¯å¾Œç«¯çš„ API è·¯å¾‘
      if (response.ok) {
        const data = await response.json();
        departmentData.value = data; // å‡è¨­è¿”å›çš„è³‡æ–™æ˜¯å­¸ç³»çš„è©³ç´°è³‡è¨Š
        console.log("å­¸ç³»è³‡æ–™:", departmentData.value);
      } else {
        console.error("ç„¡æ³•å–å¾—å­¸ç³»è³‡æ–™", response.status);
      }
    } catch (error) {
      console.error("ç™¼ç”ŸéŒ¯èª¤:", error);
    }
  } else {
    console.error("æ²’æœ‰å­¸ç³» IDï¼Œç„¡æ³•å–å¾—å­¸ç³»è³‡æ–™");
  }
};

onMounted(() => {
  updateUserData();
  getDepartmentData();
});

watch(
  () => session.value,
  () => {
    updateUserData();
    getDepartmentData();
  }
);
</script>


<style scoped>
.info-wrapper {
  margin-top: 270px;
}
.section-title {
  margin-left: 5%;
}

.custom-hr1 {
  position: absolute;
  top: 185px;
  border: 0.5px solid;
  width: 90%;
  margin-left: auto;
  margin-right: auto;
  left: 5%;
}
.custom-hr2 {
  border: 0.5px solid;
  width: 90%;
  margin-left: auto;
  margin-right: auto;
}

</style>
